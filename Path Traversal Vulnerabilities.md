---
title: Path Traversal Vulnerabilities

---

# Path Traversal Vulnerabilities

#### 1.1 Vậy lỗ hổng Path Traversal là gì?

Path Traversal là lỗ hổng cho web cho phép attacker có thể truy cập và đọc các file không mong muốn trên server. Dẫn tới việc lộ thông tin nhạy cảm như `thông tin đăng nhập` hay 1 số file hoặc thư mục trên hệ điều hành. Một số trường hợp cho phép `ghi Files` trên server cho phép attacker có thể thay đổi dữ liệu thậm chí là `chiếm quyền điều khiển server`.

---
#### 1.2 Path traversal có thể xuất hiện ở đấu
Có thể xuất hiện ở bất kì đâu đâu nếu không có các biện pháp lọc kí tự mà người dùng nhập vào và rằng buộc phân quyền rõ ràng cho file và folder được phép truy cập vào

---
#### 1.3 Nguyên Nhân
- Không phân quyền rõ ràng và không lọc ra kí tự mà người dùng nhập vào có an toàn hay không

-> *Attacker có thể lợi dụng các dấu phân cách thư mục để có thể truy cập và chỉnh sửa các file có trên hệ thống.*

---

# 2. Lab

## level 1

#### 1.Phân tích code

```
<?php 
$file_name = $_GET['file_name'];
$file_path = '/var/www/html/images/' . $file_name; 
var_dump($file_path);
if (file_exists($file_path)) {
    header('Content-Type: image/png');
    readfile($file_path);
}
else { // Image file not found
    echo " 404 Not Found";
```
Xem đoạn code trên, ta có thể thấy được rằng biến $file_path dùng để lưu đường dẫn của ảnh mà người dùng mở. tại đây ta có thể ta cả thể var_dump để thấy được rõ hơn đường dẫn.
Câu lệnh if dùng để kiểm tra xem đường dẫn trên có tồn tại hay không, hàm readfile dùng để đọc và hiển thị trực tiếp tệp tin.

---

#### 2. attack
![ảnh](https://hackmd.io/_uploads/S1wZyKOnA.png)
Chức năng của ứng dụng
- Đây là 1 web để xem hình ảnh, bấm vào nút view thì hình ảnh tương ứng sẽ hiện ra

#### Đặt giả thuyết
- chẳng hạnnhư hình ảnh trên có URL là:
    `http://localhost:8091/loadImage.php?file_name=flag.png`

    Khi truy cập vào URL trên, ta đang thực hiện 1 lệnh GET request đền endpoint của file loadimage.php với giá trị param file_name là flag.png đề load hình ảnh lá cờ
    
- Đoạn code của file loadimage.php:
- ![ảnh](https://hackmd.io/_uploads/BJFLVtdnR.png)

- như đã phân tích, đoạn code này tạo ra file_path bằng cách nối chuỗi 'var/www/html/image/' với biến $file_name, sau đó kiểm tra xem đường dẫn file có tồn tại không. Và đọc file với hàm readfile().
-  Dòng số 2 là 1 untrusted data nhưng anh dev đã không hề có biện pháp phòng chống và khiến ứng dụng dính lỗi path traversal

#### Chứng minh giả thuyết
- ta có thông tin của thư mục bắt đầu: 'var/www/html.image'
- Đích đền: etc/passwd
- ta sử dụng 4 kí tự ../ tưng ứng với mõi lần quay lại với 1 thư mục
- `'/var/www/html/images/../../../../etc/passwd`
- như vậy ta sẽ trở lại thư mục gốc và bắt đầu với etc/passwd
- ta sẽ vào burp xem kết quả:
- ![ảnh](https://hackmd.io/_uploads/BkmNvt_3A.png)





---
## level 2
Ở bài lab thứ 2, chức năng của ứng dụng vẫn giống bài 1
#### 1. phân tích
![ảnh](https://hackmd.io/_uploads/HkFypXY3C.png)

- Ở level 2, anh dev đã thêm 1 filter cho phép lọc ra kí tự `..`, nếu trong đường dẫn có chứa kí tự `..` thì sẽ trả về là die để chặn chúng ta có thể sử dụng kí tự`..` trờ về thư mục gốc. 
- Và ở câu điều kiện tiếp theo, đoạn code kiểm tra xem có tổn tại biến `$file` hay không, nếu có sẽ sử dụng hàm readfile để đọc. Có thể thấy biến `$file` được đọc trực tiếp nên chúng ta chỉ cần sử dụng `đường dẫn tuyệt đối` thay vì sử dụng kí tự `..` giống bài trước

#### 2. attack
- Đưa vào  1 đường tuyệt đối `etc/passwd`
 ![ảnh](https://hackmd.io/_uploads/SJbAyVK20.png)
- vào burp, chúng ta có thể nhìn rõ hơn
 ![ảnh](https://hackmd.io/_uploads/ryvblNKhR.png)

---

## level 3
Đây là 1 trang web cho phép người dùng up file và xem file
![ảnh](https://hackmd.io/_uploads/SywaiKtn0.png)

#### 1. Phân tích
![ảnh](https://hackmd.io/_uploads/ryLHCFKhR.png)

- Qua đoạn code trên, ta có thể thấy đoạn code tạo thư mục dir từ dòng 5->11
- từ dòng 17->19 ta có thể nhận thấy untrusted data là biến `$_POST['album']`, như vậy ta có thể kiểm soát được biến `$album`

- Trang web cho phép chúng ta uploaf file và xem file 
- Ta sẽ up thử 1 file php xem trang có thực thực thi file php hay không.
 ![ảnh](https://hackmd.io/_uploads/HJ4jrct2C.png)
->như vậy, trang cho phép chung ta up file thực thi php. Tuy nhiên, trang web lại không thực thi file php mà sẽ hiện thực dưới dạng text

![ảnh](https://hackmd.io/_uploads/r1bVi5F3C.png)
Như ảnh trên, ta có thể thấy được file apache được cấu hình đường dẫn sẽ không thực thi bất kì đuôi file nào. Những đuổi file là `jpg, png` sẽ thực thi bình thường còn những `file html,txt,php sẽ chuyển về text`.

---

#### Attack
Dựa đoạn code trên ta đã biết cấu hình path được anh dev cấu hình đẻ lọc nhưng file có đuôi là html, text, php là:
`'/var/www/html/upload/'.đường dẫn đến album`
- Có thể thấy rằng path đường nối với album
- Nên trong burp, ta thấy ban đầu đường dẫn sẽ trông như thế này
`string(59) "/var/www/html/upload/5e55305bc2c603ec5d587565dbf462dd/test.php`
- Để có thể bỏ qua lọc đường dẫn của dev, ta phải thêm ../.. để trở về thư mục có thể thực thi được file php.
`"/var/www/html/upload/5e55305bc2c603ec5d587565dbf462dd/../../`
và từ đây đường dẫn sẽ là
`"/var/www/html/`
Quay lại trang web, chúng chỉ cần truy cập lại lại
![ảnh](https://hackmd.io/_uploads/SJovtiKhC.png)
như vậy là đã thực thi được file php

---

 
## level 4

![ảnh](https://hackmd.io/_uploads/SJce6rjhR.png)
![ảnh](https://hackmd.io/_uploads/BJJEaSj3C.png)
- Đây là 1 trang web cho phép người dùng chơi game
![ảnh](https://hackmd.io/_uploads/HyDHaHohC.png)
- Trang cho phép người dùng upload avatar

#### Phân tích code
![ảnh](https://hackmd.io/_uploads/ByMakUs3R.png)
- Trên đoạn code trên, ta thấy được 1 untrusted data là biến $_POST["name"], nhưng khi qua 1 lớp kiểm tra biến trước khi vào - cụ thể là kiểm tra kí tự người dùng nhập vào nếu không thuộc từ a->z và 0->9 thì sẽ in ra lỗi. Nên đây chưa chắc đã là untrusted data.

![ảnh](https://hackmd.io/_uploads/BJUlF8onR.png)
- Ở đây, ta có thể thấy được khi upload file lên thì đường dẫn sẽ luôn luôn là name."avatar.jpg". 

- Ở file game.php
![ảnh](https://hackmd.io/_uploads/B1JGJwj20.png)
- mặc định nếu không thay đổi đường dẫn của game sẽ là:
 `http://localhost:8094/game.php?game=fatty-bird-1.html`
- Ta có thể thay đổi đường dẫn này đến game khác
- ta có thể dễ dàng nhận thấy untrusted data xuất hiện, ta có thể dựa vào hàm include để thực hiện biến game hoặc gọi đến bất kì file vào trong hệ thống

---

#### Attack
b1: Đầu tiên ta sẽ upload lên trang file bất kì ở Profile với nội dung thực thi file php, tuy nhiên anh dev đã cấu hình những đuôi file html, text, php sẽ đều chuyển về dạng text nên không thực trực tiếp thực hiện được nội dung trong file
![ảnh](https://hackmd.io/_uploads/rJTLbvi3A.png)
Ta có thể nhận thấy rằng đường dẫn se là: `var/www/html/upload/duong/avatar.jpg`

b2: Khai thác include
biến game được nằm trong thư mục view, vì vậy chúng ta cần phải sử dụng ../ để thoát khỏi thư mục view. Sẽ có dạng như này:
`var/www/html/view/game=fatty-bird-1.html`
- ta sẽ chuyển thành `var/www/html/view/game=../upload/duong/avatar.jpg`
- Đường dẫn sau khi thay đổi sẽ có dạng như này:
`http://localhost:8094/game.php?game=../upload/duong/avatar.jpg`
![ảnh](https://hackmd.io/_uploads/ByHsmwinC.png)
- Và như vậy đã thực thi được file php

-------------
# Lab portswigger
## level 1
### Đề bài:
![ảnh](https://hackmd.io/_uploads/B14Uq3kAR.png)

---
### Phân tích:
- ta thấy đây là trang web cho phép hiển thị hình ảnh
![ảnh](https://hackmd.io/_uploads/ryFYOhJAC.png)
ta thấy đây là trang web cho phép hiển thị hình ảnh

---
### attack 
![ảnh](https://hackmd.io/_uploads/BkKEY3JRR.png)
- b1: Mở burp và bắt lấy goi tin chưa filename
- b2:Thay đổi filename= ../../../etc/passwd



## Level 2

### Đề bài 
- Đây là bài liên quan đến bypass đường dẫn tuyệt đối
![ảnh](https://hackmd.io/_uploads/B18Dn21AC.png)
### Attack
![ảnh](https://hackmd.io/_uploads/Bknd6nJ00.png)
- Chỉ cần thay đổi filename = /etc/passwd


